#!/bin/bash

echo "=========================================="
echo "  Law Bot - Обновление из GitHub"
echo "=========================================="

cd /opt/law_bot

# Pull новых изменений
echo "[1/5] Получение обновлений из GitHub..."
git pull origin main

if [ $? -ne 0 ]; then
    echo "❌ Ошибка: не удалось получить обновления"
    exit 1
fi

echo "✅ Код обновлён"

# Остановка старых контейнеров
echo "[2/5] Остановка сервисов..."
docker-compose down

echo "✅ Сервисы остановлены"

# Пересборка контейнеров без кэша
echo "[3/5] Пересборка контейнеров..."
docker-compose build --no-cache bot

if [ $? -ne 0 ]; then
    echo "❌ Ошибка: не удалось собрать контейнеры"
    exit 1
fi

echo "✅ Контейнеры собраны"

# Запуск сервисов
echo "[4/5] Запуск сервисов..."
docker-compose up -d

if [ $? -ne 0 ]; then
    echo "❌ Ошибка: не удалось запустить сервисы"
    exit 1
fi

echo "✅ Сервисы запущены"

# Ожидание запуска
echo "[5/5] Ожидание запуска (15 сек)..."
sleep 15

# Проверка статуса
echo ""
echo "=========================================="
echo "  Статус сервисов:"
echo "=========================================="
docker-compose ps

echo ""
echo "=========================================="
echo "  Последние логи бота:"
echo "=========================================="
docker-compose logs --tail=30 bot

echo ""
echo "=========================================="
echo "  ✅ Обновление завершено!"
echo "=========================================="
