#!/bin/bash

echo "=========================================="
echo "  Law Bot - Обновление из GitHub"
echo "=========================================="

cd /opt/law_bot

# Pull новых изменений
echo "[1/4] Получение обновлений из GitHub..."
git pull origin main

if [ $? -ne 0 ]; then
    echo "❌ Ошибка: не удалось получить обновления"
    exit 1
fi

echo "✅ Код обновлён"

# Пересборка контейнеров
echo "[2/4] Пересборка контейнеров..."
docker-compose build --no-cache

if [ $? -ne 0 ]; then
    echo "❌ Ошибка: не удалось собрать контейнеры"
    exit 1
fi

echo "✅ Контейнеры собраны"

# Перезапуск сервисов
echo "[3/4] Перезапуск сервисов..."
docker-compose up -d --force-recreate

if [ $? -ne 0 ]; then
    echo "❌ Ошибка: не удалось запустить сервисы"
    exit 1
fi

echo "✅ Сервисы перезапущены"

# Ожидание запуска
echo "[4/4] Ожидание запуска (10 сек)..."
sleep 10

# Проверка статуса
echo ""
echo "=========================================="
echo "  Статус сервисов:"
echo "=========================================="
docker-compose ps

echo ""
echo "=========================================="
echo "  Последние логи бота:"
echo "=========================================="
docker-compose logs --tail=20 bot

echo ""
echo "=========================================="
echo "  ✅ Обновление завершено!"
echo "=========================================="
