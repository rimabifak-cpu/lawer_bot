<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel - Law Bot</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h2 { color: #555; border-bottom: 2px solid #28a745; padding-bottom: 10px; margin-top: 30px; }
        .section { margin-bottom: 30px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-links { margin-bottom: 20px; padding: 15px; background: #007bff; border-radius: 8px; }
        .nav-links a { color: white; text-decoration: none; margin-right: 20px; font-weight: bold; }
        .nav-links a:hover { text-decoration: underline; }
        .btn { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .btn-details { padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-details:hover { background: #218838; }
        
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; }
        .modal-close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover { color: #000; }
        .detail-row { margin-bottom: 15px; }
        .detail-label { font-weight: bold; color: #555; }
        .detail-value { margin-top: 5px; padding: 8px; background: #f8f9fa; border-radius: 4px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üìã Admin Panel - Law Bot</h1>
    
    <div class="nav-links">
        <span>üìÅ –ù–∞–≤–∏–≥–∞—Ü–∏—è:</span>
        <a href="/test">üè† –ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/dialogs">üí¨ –î–∏–∞–ª–æ–≥–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</a>
    </div>
    
    <p>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: <span id="load-time"></span></p>
    
    <div class="section">
        <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</h2>
        <table id="users-referrals-table">
            <thead>
                <tr>
                    <th>–ò–º—è</th>
                    <th>–õ–æ–≥–∏–Ω</th>
                    <th>–ö—Ç–æ –µ–≥–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª (–†–µ—Ñ–µ—Ä–∞–ª)</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</th>
                </tr>
            </thead>
            <tbody id="users-referrals-body">
                <tr><td colspan="4">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div class="section">
        <h2>–ê–Ω–∫–µ—Ç—ã –¥–µ–ª (API: /api/requests)</h2>
        <table id="requests-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                    <th>–ü—Ä–µ–¥–º–µ—Ç —Å–ø–æ—Ä–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</th>
                    <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                </tr>
            </thead>
            <tbody id="requests-body">
                <tr><td colspan="6">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div class="section">
        <h2>–ü–∞—Ä—Ç–Ω—ë—Ä—ã (API: /api/partners)</h2>
        <table id="partners-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–§–ò–û</th>
                    <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                    <th>Email</th>
                </tr>
            </thead>
            <tbody id="partners-body">
                <tr><td colspan="4">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div class="section">
        <h2>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</h2>
        <form id="direct-message-form">
            <select id="user-select" style="padding: 8px; margin-right: 10px;">
                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
            </select>
            <input type="text" id="message-text" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è" style="padding: 8px; width: 300px; margin-right: 10px;">
            <button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
        <p id="send-result"></p>
    </div>
    
    <div class="section">
        <h2>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        <pre id="debug-info" style="background: #f5f5f5; padding: 10px; overflow-x: auto;"></pre>
    </div>

    <script>
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('load-time').textContent = new Date().toLocaleString();
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∞–Ω–∫–µ—Ç
        let allRequests = [];
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è select
        async function loadUsersList() {
            const select = document.getElementById('user-select');
            try {
                const response = await fetch('/api/users/list');
                const users = await response.json();
                
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</option>';
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.telegram_id;
                    option.textContent = user.display_name;
                    select.appendChild(option);
                });
            } catch (e) {
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('direct-message-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const telegramId = document.getElementById('user-select').value;
            const message = document.getElementById('message-text').value;
            const resultEl = document.getElementById('send-result');
            
            if (!telegramId) {
                resultEl.textContent = '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                resultEl.style.color = 'red';
                return;
            }
            
            resultEl.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            try {
                const response = await fetch('/api/messages/direct', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegram_id: parseInt(telegramId),
                        message: message
                    })
                });
                
                if (response.ok) {
                    resultEl.textContent = '‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
                    resultEl.style.color = 'green';
                } else {
                    const error = await response.json();
                    resultEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                    resultEl.style.color = 'red';
                }
            } catch (e) {
                resultEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
                resultEl.style.color = 'red';
            }
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadUsersList();
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª–µ–π –¥–µ–ª–∞
        function showCaseDetails(requestId) {
            const req = allRequests.find(r => r.id === requestId);
            if (!req) {
                alert('–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            const modal = document.getElementById('case-details-modal');
            const content = document.getElementById('case-details-content');
            
            const userInfo = req.user ? `${req.user.first_name || ''} ${req.user.last_name || ''} (@${req.user.username || '–Ω–µ—Ç'})` : 'N/A';
            
            content.innerHTML = `
                <div class="detail-row"><div class="detail-label">ID –∑–∞—è–≤–∫–∏:</div><div class="detail-value">${req.id}</div></div>
                <div class="detail-row"><div class="detail-label">–ö–ª–∏–µ–Ω—Ç:</div><div class="detail-value">${userInfo}</div></div>
                <div class="detail-row"><div class="detail-label">–°—Ç–∞—Ç—É—Å:</div><div class="detail-value">${req.status}</div></div>
                <div class="detail-row"><div class="detail-label">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</div><div class="detail-value">${req.created_at ? new Date(req.created_at).toLocaleString() : '-'}</div></div>
                <div class="detail-row"><div class="detail-label">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:</div><div class="detail-value">${req.sent_at ? new Date(req.sent_at).toLocaleString() : '-'}</div></div>
                <div class="detail-row"><div class="detail-label">–°—Ç–æ—Ä–æ–Ω—ã (–∏—Å—Ç–µ—Ü/–æ—Ç–≤–µ—Ç—á–∏–∫):</div><div class="detail-value">${req.parties_info || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">–ü—Ä–µ–¥–º–µ—Ç —Å–ø–æ—Ä–∞:</div><div class="detail-value">${req.dispute_subject || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">–ü—Ä–∞–≤–æ–≤–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:</div><div class="detail-value">${req.legal_basis || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Å–æ–±—ã—Ç–∏–π:</div><div class="detail-value">${req.chronology || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞:</div><div class="detail-value">${req.evidence || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">–ü—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è:</div><div class="detail-value">${req.procedural_history || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">–¶–µ–ª—å –∫–ª–∏–µ–Ω—Ç–∞:</div><div class="detail-value">${req.client_goal || '-'}</div></div>
            `;
            
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('case-details-modal').style.display = 'none';
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('case-details-modal');
            if (event.target === modal) modal.style.display = 'none';
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ fetch
        async function loadData() {
            const debug = [];
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∫–µ—Ç—ã
                debug.push('–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∫–µ—Ç...');
                const requestsRes = await fetch('/api/requests');
                debug.push('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –∞–Ω–∫–µ—Ç: ' + requestsRes.status);
                allRequests = await requestsRes.json();
                debug.push('–ü–æ–ª—É—á–µ–Ω–æ –∞–Ω–∫–µ—Ç: ' + allRequests.length);
                
                let requestsHtml = '';
                if (allRequests.length === 0) {
                    requestsHtml = '<tr><td colspan="6">–ù–µ—Ç –∞–Ω–∫–µ—Ç</td></tr>';
                } else {
                    for (const req of allRequests) {
                        const client = req.user ? req.user.first_name : 'N/A';
                        const subject = (req.dispute_subject || '-').substring(0, 30);
                        const status = req.status;
                        const date = req.sent_at ? new Date(req.sent_at).toLocaleString() : '-';
                        requestsHtml += `<tr><td>${req.id}</td><td>${client}</td><td>${subject}...</td><td>${status}</td><td>${date}</td><td><button class="btn-details" onclick="showCaseDetails(${req.id})">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button></td></tr>`;
                    }
                }
                document.getElementById('requests-body').innerHTML = requestsHtml;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
                debug.push('');
                debug.push('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤...');
                const partnersRes = await fetch('/api/partners');
                debug.push('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤: ' + partnersRes.status);
                const partners = await partnersRes.json();
                debug.push('–ü–æ–ª—É—á–µ–Ω–æ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤: ' + partners.length);
                
                let partnersHtml = '';
                if (partners.length === 0) {
                    partnersHtml = '<tr><td colspan="4">–ù–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤</td></tr>';
                } else {
                    for (const p of partners) {
                        partnersHtml += `<tr><td>${p.id}</td><td>${p.full_name}</td><td>${p.company_name}</td><td>${p.email}</td></tr>`;
                    }
                }
                document.getElementById('partners-body').innerHTML = partnersHtml;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                debug.push('');
                debug.push('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤...');
                const usersRes = await fetch('/api/users/referrals-info');
                debug.push('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + usersRes.status);
                const usersResponse = await usersRes.json();
                const usersData = usersResponse.users || usersResponse;
                debug.push('–ü–æ–ª—É—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + usersData.length);
                
                let usersHtml = '';
                if (usersData.length === 0) {
                    usersHtml = '<tr><td colspan="4">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
                } else {
                    for (const u of usersData) {
                        const referrer = u.invited_by ? (u.invited_by.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') : '-';
                        const refCount = u.invited_count || 0;
                        usersHtml += `<tr><td>${u.name}</td><td>${u.username || '-'}</td><td>${referrer}</td><td>${refCount}</td></tr>`;
                    }
                }
                document.getElementById('users-referrals-body').innerHTML = usersHtml;
                
            } catch (e) {
                debug.push('–û—à–∏–±–∫–∞: ' + e.message);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            document.getElementById('debug-info').textContent = debug.join('\n');
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loadData();
    </script>
    
    <!-- Modal for case details -->
    <div id="case-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏</h2>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div id="case-details-content"></div>
        </div>
    </div>
</body>
</html>
